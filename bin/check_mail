#! /bin/zsh
mbsync -a 1>&2 2>!~/.mailsync.log
notmuch new

# Remove Logwatch emails
notmuch tag +deleted -new -- tag:new and subject:'logwatch for'

# Remove Titan Queues Stuck
# notmuch tag +deleted -- 'tag:new and subject:Titan Queues \
#   and from:titan.admin@gtri.gatech.edu and to:titan.admin@gtri.gatech.edu'
notmuch tag +deleted -unread -new -- 'subject:Titan Queues Stuck: groups_needing_correlation
   and from:titan.admin@gtri.gatech.edu and to:titan.admin@gtri.gatech.edu'

notmuch tag +deleted -unread -new -- 'subject:Titan Queues Stuck: done
   and from:titan.admin@gtri.gatech.edu and to:titan.admin@gtri.gatech.edu'

# Remove the USN stuff from inbox
notmuch tag -inbox +USN -new -- 'to:ubuntu-security-announce@lists.ubuntu.com'

# Remove the openssl-announce mailing list
notmuch tag +OpenSSL -inbox -new -- 'to:openssl-announce@openssl.org'

# Remove OpenBSD's mail server status reports
notmuch tag +cron -new -unread -inbox -- tag:new and from:'Charlie Root'

# Remove Apiary's usage report
notmuch tag +reports +cron -new -unread -inbox -- 'tag:new and subject:Usage report for'
notmuch tag +cron -new -inbox -unread -- '(subject:Cron <mars@ or subject:Cron <root@) and from:Cron Daemon'

# Tag mail from Gvu/MS-COC/Ga Tech in general so that it's available, but unseen
notmuch tag +GVU -new -- 'to:gvu-students-hci@cc.gatech.edu or to:gvu-students-grad@cc.gatech.edu'
notmuch tag +COC -new -- subject:'Ms-coc-announce'
notmuch tag +deleted -new -inbox -- 'to:studentevents@lists.gatech.edu'
notmuch tag +deleted -new -inbox -- 'to:dailydigest@lists.gatech.edu'
notmuch tag +deleted -new -inbox -- 'from:updates@gtathletics.fan-one.com'

# Handle some tags from JIRA/Stash
notmuch tag +jira -new -- 'from:ctisl.jira@gtri.gatech.edu'
notmuch tag +stash -new -- 'from:ctisl.stash@gtri.gatech.edu'

# Tag mail that I sent as 'sent' and remove it from my inbox
notmuch tag +sent -inbox -new 'from:Bryan.Bennett@gtri.gatech.edu or from:bbennett37@gatech.edu or from:bbenne10@gmail.com'

# Now some general tags that somewhat replicate folders
# notmuch tag +Apiary "subject:Apiary"

notmuch tag +inbox -new 'tag:new and tag:unread'

count=$(notmuch count tag:inbox and tag:unread)
if [[ count -gt 1 ]]; then
  echo "$count new mails"
  /usr/bin/notify-send "Work: $count new mails"
  mpv ~/.local/share/bell.wav 1>/dev/null 2>/dev/null
fi
