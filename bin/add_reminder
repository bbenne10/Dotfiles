#! /usr/bin/env python3
import base64
import email.parser as email_parser
import fileinput
import io
import subprocess
import time

parser = email_parser.Parser()
def _parse_msg(payload, invites=[]):
    if payload.is_multipart():
        for payload in payload.get_payload():
            _parse_msg(payload, invites)
    else:
        if payload.get_content_type() == 'text/calendar':
            invites.append(base64.b64decode(payload.get_payload()))


if __name__ == '__main__':
    lines = []
    for line in fileinput.input():
        lines.append(line)

    msg = parser.parsestr(''.join(lines))

    invites = []
    _parse_msg(msg, invites)
    if not invites:
        print("No icalendar event found in message!")
        time.sleep(1)
    else:
        err = False
        for invite in invites:
            proc = subprocess.Popen(['khal', 'import', '--batch', '-'],
                                    stdin=subprocess.PIPE)
            proc.communicate(invite)
            if proc.returncode != 0:
                print('Khal returned {} when attempting to import...'.format(
                    proc.returncode))
                time.sleep(1)
                err = True

        if not err:
            print('Added invite(s) to calendar!')
            time.sleep(2)
